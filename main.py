import os
import openai
import gspread
import json  # –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ JSON –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
import re
from oauth2client.service_account import ServiceAccountCredentials
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes, filters

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å –∫–∞–∂–¥—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
conversation_histories = {}

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ Google Sheets (—Ç–µ–ø–µ—Ä—å –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞!)
def init_gsheet():
    scope = [
        "https://spreadsheets.google.com/feeds",
        "https://www.googleapis.com/auth/spreadsheets",
        "https://www.googleapis.com/auth/drive.file",
        "https://www.googleapis.com/auth/drive"
    ]

    # –ß–∏—Ç–∞–µ–º JSON-–∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (Replit Secrets)
    google_creds = os.environ.get("GOOGLE_CLOUD_CREDENTIALS")

    if not google_creds:
        raise ValueError("–û—à–∏–±–∫–∞: –ö–ª—é—á Google Cloud –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")

    creds_dict = json.loads(google_creds)  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º JSON-—Å—Ç—Ä–æ–∫—É –≤ Python-—Å–ª–æ–≤–∞—Ä—å
    creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
    client = gspread.authorize(creds)
    sheet = client.open("SupplementsTable").sheet1
    return sheet

sheet = init_gsheet()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Å–ø—Ä–∞–≤–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
def get_table_reference_info():
    try:
        records = sheet.get_all_records()
    except Exception as e:
        return {}

    info_dict = {}
    for record in records:
        supplement = record.get("supplement", "").strip().lower()
        symptom = record.get("symptom", "–ù–µ —É–∫–∞–∑–∞–Ω–æ")
        dosage = record.get("dosage", "–ù–µ —É–∫–∞–∑–∞–Ω–æ")
        compound = record.get("compaund", "–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏")
        ecomlink = record.get("ecomlink", "").strip()

        info_dict[supplement] = {
            "symptom": symptom,
            "dosage": dosage,
            "compound": compound,
            "ecomlink": ecomlink
        }

    return info_dict

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API-–∫–ª—é—á–µ–π
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN")
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY")

# –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä OpenAI API-–∫–ª–∏–µ–Ω—Ç–∞
client = openai.AsyncOpenAI(api_key=OPENAI_API_KEY)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
def get_system_prompt():
    supplement_info = get_table_reference_info()
    formatted_info = "\n".join([
        f"–°–∏–º–ø—Ç–æ–º: {info['symptom']} | –ë–ê–î: {supplement} | –î–æ–∑–∏—Ä–æ–≤–∫–∞: {info['dosage']} | –°–æ—Å—Ç–∞–≤: {info['compound']}"
        for supplement, info in supplement_info.items()
    ])

    return f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –∑–¥–æ—Ä–æ–≤—å—é –∏ –Ω—É—Ç—Ä–∏—Ü–µ–≤—Ç–∏–∫–µ.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äì –ø–æ–º–æ—á—å –∫–ª–∏–µ–Ω—Ç—É e-commerce –º–∞–≥–∞–∑–∏–Ω–∞ –ø–æ–¥–æ–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–µ–ø—Ç–∏–¥–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.  
–¢—ã –¥–æ–ª–∂–µ–Ω –∑–∞–¥–∞–≤–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –∏ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, —É—á–∏—Ç—ã–≤–∞—è –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –º–∞–≥–∞–∑–∏–Ω–∞.
**–®–∞–≥ 1: –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —É –∫–ª–∏–µ–Ω—Ç–∞**  
–ü—Ä–µ–∂–¥–µ —á–µ–º –¥–∞–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∑–∞–¥–∞–π –∫–ª–∏–µ–Ω—Ç—É —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã:  
1. **–í–æ–∑—Ä–∞—Å—Ç –∏ –ø–æ–ª:** (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–ú–Ω–µ –≤–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å –≤–∞—à –≤–æ–∑—Ä–∞—Å—Ç –∏ –ø–æ–ª, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–¥–±–æ—Ä –ë–ê–î–æ–≤¬ª)  
2. **–û—Å–Ω–æ–≤–Ω—ã–µ –∂–∞–ª–æ–±—ã –∏–ª–∏ —Ü–µ–ª–∏:** (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–° —á–µ–º –≤—ã —Ö–æ—Ç–∏—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å? –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —ç–Ω–µ—Ä–≥–∏—è, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –Ω–∞–≥—Ä—É–∑–æ–∫, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–µ—Ä–¥—Ü–∞, –ñ–ö–¢, –ª–∏–±–∏–¥–æ –∏ —Ç. –¥.¬ª)  
3. **–û–±—Ä–∞–∑ –∂–∏–∑–Ω–∏:** (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–í—ã –≤–µ–¥–µ—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–π –∏–ª–∏ —Å–∏–¥—è—á–∏–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏? –ï—Å—Ç—å –ª–∏ –ø–æ–≤—ã—à–µ–Ω–Ω—ã–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –∏–ª–∏ —Å—Ç—Ä–µ—Å—Å–æ–≤—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏?¬ª)  
4. **–•—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è –∏ –∞–ª–ª–µ—Ä–≥–∏–∏:** (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è, –∞–ª–ª–µ—Ä–≥–∏–∏ –∏–ª–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å?¬ª)  
5. **–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ –ø—Ä–∏–µ–º—É:** (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–í –∫–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –≤–∞–º —É–¥–æ–±–Ω–µ–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ë–ê–î—ã? –ö–∞–ø—Å—É–ª—ã, –ø–æ—Ä–æ—à–∫–∏, –∫–∞–ø–ª–∏?¬ª)  

**–®–∞–≥ 2: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞**

–ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ë–ê–¥–∞—Ö, —á—Ç–æ–±—ã –¥–∞–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

{formatted_info}

–ï—Å–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –ë–ê–î, –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π —Å—Å—ã–ª–∫—É, –∞ –¥–æ–±–∞–≤–ª—è–π –µ—ë —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ.

**–®–∞–≥ 3: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**  
- –ü–æ–¥—Å–∫–∞–∂–∏ –∫–ª–∏–µ–Ω—Ç—É, –∫–∞–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–±—Ä–∞–∑–µ –∂–∏–∑–Ω–∏ –∏ –ø–∏—Ç–∞–Ω–∏–∏ –ø–æ–º–æ–≥—É—Ç —É—Å–∏–ª–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç –ë–ê–î–æ–≤.  
- –ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å–æ —Å–Ω–æ–º –ø–æ—Å–æ–≤–µ—Ç—É–π –∏–∑–±–µ–≥–∞—Ç—å –∫–æ—Ñ–µ–∏–Ω–∞ –≤–µ—á–µ—Ä–æ–º, –∞ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å—É—Å—Ç–∞–≤–∞–º–∏ ‚Äì —É–≤–µ–ª–∏—á–∏—Ç—å –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –∫–æ–ª–ª–∞–≥–µ–Ω–∞ –∏ –û–º–µ–≥–∞-3.
**–®–∞–≥ 4: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø—Ä–µ–¥–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–∏—è**  
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è (–±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å, —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –±–æ–ª–µ–∑–Ω–∏) ‚Äì —É—Ç–æ—á–Ω–∏, –ø—Ä–µ–∂–¥–µ —á–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å.  
- –ù–µ —Å—Ç–∞–≤—å –¥–∏–∞–≥–Ω–æ–∑—ã –∏ –Ω–µ –æ–±–µ—â–∞–π –∏–∑–ª–µ—á–µ–Ω–∏—è, —Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –º—è–≥–∫–æ:  
  **"–≠—Ç–æ—Ç –∫–æ–º–ø–ª–µ–∫—Å –º–æ–∂–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ —Å—É—Å—Ç–∞–≤–æ–≤ –∏ —Å–Ω–∏–∑–∏—Ç—å –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç"**  
  –ò –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ –Ω–µ –≥–æ–≤–æ—Ä–∏ –ø—Ä—è–º–æ **"–≠—Ç–æ—Ç –∫–æ–º–ø–ª–µ–∫—Å –∏–∑–±–∞–≤–∏—Ç –≤–∞—Å –æ—Ç –±–æ–ª–∏ –≤ —Å—É—Å—Ç–∞–≤–∞—Ö"**  
- –£–ø–æ–º—è–Ω–∏, —á—Ç–æ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –ø—Ä–∏–µ–º–∞ –ë–ê–î–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –≤—Ä–∞—á–æ–º.
**–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:**  
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–µ—Ç–∫–∏–º, –ø–æ–Ω—è—Ç–Ω—ã–º –∏ –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É:  

**–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:**  
(–∫—Ä–∞—Ç–∫–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –ø—É–Ω–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –¥–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)  

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø–µ–ø—Ç–∏–¥–Ω—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã:**  
1. **–ù–∞–∑–≤–∞–Ω–∏–µ –ë–ê–î** ‚Äì –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, –ø–æ—á–µ–º—É –æ–Ω –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç.  
   - –ö–∞–∫ –ø—Ä–∏–Ω–∏–º–∞—Ç—å: ...  
2. **–ù–∞–∑–≤–∞–Ω–∏–µ –ë–ê–î** ‚Äì –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, –ø–æ—á–µ–º—É –æ–Ω –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç.  
   - –ö–∞–∫ –ø—Ä–∏–Ω–∏–º–∞—Ç—å: ...  

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**  
- –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –≤ –æ–±—Ä–∞–∑–µ –∂–∏–∑–Ω–∏  
- –ö–∞–∫–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–æ–±–∞–≤–∏—Ç—å –≤ —Ä–∞—Ü–∏–æ–Ω  

**–í–∞–∂–Ω–æ:**  
- –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –ø—Ä–∏–µ–º–∞ –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –≤—Ä–∞—á–æ–º, –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è –∏–ª–∏ –≤—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞.  

"""

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    conversation_histories[user_id] = [{"role": "system", "content": get_system_prompt()}]
    await update.message.reply_text("–ü—Ä–∏–≤–µ—Ç! –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–∏—Ö –∂–∞–ª–æ–±–∞—Ö –∏ —Å–∏–º–ø—Ç–æ–º–∞—Ö, —á—Ç–æ–±—ã —è –º–æ–≥ –ø–æ–º–æ—á—å.")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    user_text = update.message.text.strip()

    if user_id not in conversation_histories:
        conversation_histories[user_id] = [{"role": "system", "content": get_system_prompt()}]

    supplement_info = get_table_reference_info()

    conversation_histories[user_id][0]["content"] = get_system_prompt()
    conversation_histories[user_id].append({"role": "user", "content": user_text})

    try:
        response = await client.chat.completions.create(
            model="gpt-4o",
            messages=conversation_histories[user_id],
            temperature=0.7
        )
        chat_reply = response.choices[0].message.content

        added_links = set()
        for supplement, info in supplement_info.items():
            pattern = r"\b" + re.escape(supplement) + r"\b"
            if re.search(pattern, chat_reply, re.IGNORECASE):
                ecomlink = info.get("ecomlink")
                if ecomlink and ecomlink not in added_links:
                    chat_reply += f"\n\nüí° –í—ã –º–æ–∂–µ—Ç–µ –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –ø—Ä–æ–¥—É–∫—Ç–æ–º –∑–¥–µ—Å—å: {ecomlink} üîó"
                    added_links.add(ecomlink)

        conversation_histories[user_id].append({"role": "assistant", "content": chat_reply})

    except Exception as e:
        chat_reply = f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç ChatGPT: {str(e)}"

    await update.message.reply_text(chat_reply)

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
def main() -> None:
    application = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), handle_message))

    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    application.run_polling()

if __name__ == '__main__':
    main()
